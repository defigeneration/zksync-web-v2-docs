# Интероперабельность L1 / L2

Хотя большинство операций исполняется на L2, некоторые из них требуют взаимодействия с сетью L1. Основными такими случаями являются: построение сложных мостов; поддержание смарт-контрактов управления, регулирующих контракты на других сетях, в одной сети и т.д.

Кроме того, резистентность к цензуре на L2 наследуется от основной сети, поэтому возможность отправлять сообщения из Эфириума в zkSync является важной частью механизма резистентности к цензуре, называемого [приоритетной очередью](interoperabelnost-l1-l2.md#priority-queue) (priority queue).

Отправка транзакций с Эфириума на zkSync происходит через смарт-контракт zkSync. Это позволяет отправителю запрашивать транзакции напрямую из L1, тем самым обеспечивая беспрепятственную передачу любых данных с Эфириума в zkSync. [Узнайте больше](https://v2-docs.zksync.io/dev/developer-guides/bridging/l1-l2.html) о передаче сообщений с L1 на L2.

### Приоритетная очередь <a href="#priority-queue" id="priority-queue"></a>

Задачей приоритетной очереди является предоставление резистентного к цензуре способа взаимодействия с zkSync в случае, если оператор становится злонамеренным или недоступным. Механизм работы приоритетной очереди на zkSync 2.0 очень близок к своему аналогу в предыдущей версии zkSync. Для полноты картины мы сначала репрезентуем способ работы приоритетной очереди на zkSync 1.x. Это даст нам понимание, почему для zkSync 2.0 необходим новый дизайн приоритетной очереди.

#### Как это работает zkSync 1.x <a href="#how-it-works-in-zksync-1-x" id="how-it-works-in-zksync-1-x"></a>

В предыдущей версии zkSync было всего две операции, которые могли быть отправлены на zkSync с L1:

* `Deposit`: перенос средств с Эфириума на zkSync.
* `FullExit`: Перенос средства назад на Эфириум. По сути, это то же самое, что и `Withdraw` в zkSync 2.0.

Если пользователь хотел отправить средства в, или вывести с zkSync, он должен был отправить запрос на транзакцию в смарт-контракт, который затем прикреплялся к двухсторонней очереди приоритетных транзакций. Двусторонняя очередь имеет следующие правила:

* Все транзакции обрабатываются поочередно.
* Каждая приоритетная операция должна быть обработана оператором в течение `X` дней с момента ее отправки в контракт.

Первое правило гарантированно обеспечивается смарт-контрактом. Второе правило может быть нарушено, если оператор становится злонамеренным или недоступным. В таком случае система входит в 'exodus mode' (режим исхода), в котором новые блоки не обрабатываются и пользователи могут извлечь свои средства без взаимодействия с оператором.

### L2 -> L1 коммуникация <a href="#l2-l1-communication" id="l2-l1-communication"></a>

[L2 -> L1 коммуникация](https://v2-docs.zksync.io/dev/developer-guides/bridging/l2-l1.html), в отличие от L1 -> L2 коммуникации, основана только на передаче информации, а не на исполнении транзакций на L1. Это встроенная функция, выполненная из двух частей: отправки сообщения с L2 и чтения его на L1. Первая часть реализована как вызов системного смарт-контракта L2. Вторая часть же реализована на смарт-контракте zkSync на L1 в виде функции получателя (getter).

#### Отправка сообщений <a href="#sending-messages" id="sending-messages"></a>

Каждое сообщение, отправленное с L2 на L1 содержит в себе адрес отправителя и само сообщение. Длина сообщения может быть произвольной, но чем длиннее сообщение, тем дороже будет стоить его отправка. Оператор должен включать все сообщения для соответствующего дерева хэшей (см. следующий абзац). Таким образом, все сообщения доступны публично, и никому не нужно полагаться на оператора, чтобы раскрыть их.

#### Чтение сообщений <a href="#reading-messages" id="reading-messages"></a>

Каждое отправленное сообщение можно прочесть он-чейн. Более того, можно доказать, что сообщение было отправлено в конкретном блоке L2. Для того, чтобы сделать таке доказательство как можно более дешевым и для пользователя, и для оператора, мы храним все сообщения, для каждого блока L2, в дереве хэшей (merkle tree). Соответственно, любой смарт-контракт на L1 может принять отправленное сообщение путем предоставления доказательства включения в какой-либо из блоков L2. Доказательство может быть сгенерированно, основываясь лишь на данных, которые оператор отправил на смарт-контракт zkSync L1. Также доказательство может быть получено через [API](https://v2-docs.zksync.io/api/api.html#zksgetl2tol1msgproof).

#### Резюме по L2->L1 коммуникации: <a href="#summary-on-l2-l1-messaging" id="summary-on-l2-l1-messaging"></a>

* Для L2 -> L1 комуникации нужна одна транзакция на L2 и одна транзакция на L1.
* Сообщения могут быть произвольной длины.
* Вся необходимая информация для доказательства включения сообщения в блок L2 всегда может быть восстановлена из Эфириума. Однако, наиболее легким способом является запрос доказательства у оператора через API.
